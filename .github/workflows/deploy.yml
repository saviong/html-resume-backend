name: Deploy Python Function App to Azure

on:
  push:
    branches:
      - master

env:
  AZURE_FUNCTIONAPP_NAME: resumevisitor-fn
  RESOURCE_GROUP_NAME: html-resume
  PYTHON_VERSION: '3.11'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout GitHub Action'
        uses: actions/checkout@v4

      - name: 'Set up Python version'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: 'Install local dependencies & verify requirements.txt'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 'Azure Login'
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: 'Set Critical App Settings for Python v2 Model'
        uses: azure/cli@v1
        with:
          inlineScript: |
            az functionapp config appsettings set \
              --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
              --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
              --settings "FUNCTIONS_EXTENSION_VERSION=~4" \
                         "FUNCTIONS_WORKER_RUNTIME=python" \
                         "AzureWebJobsFeatureFlags=EnableWorkerIndexing" \
                         "SCM_DO_BUILD_DURING_DEPLOYMENT=true"

      - name: 'Zip artifact for deployment'
        run: zip -r function-app.zip . -x "*.git*" "*.github*" "local.settings.json" "*.venv/*" "__pycache__/*"

      - name: 'DIAGNOSTIC: Inspect Zip Contents'
        run: |
          unzip -l function-app.zip
          
      - name: 'Deploy to Azure Functions'
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
          package: function-app.zip

      - name: 'Verify Function Discovery'
        uses: azure/cli@v1
        with:
          inlineScript: |
            echo "Waiting 60 seconds for function app to restart and index..."
            sleep 60
            echo "Listing functions in ${{ env.AZURE_FUNCTIONAPP_NAME }}..."
            az functionapp function list \
              --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
              --name ${{ env.AZURE_FUNCTIONAPP_NAME }} -o table
            COUNT=$(az functionapp function list -g ${{ env.RESOURCE_GROUP_NAME }} -n ${{ env.AZURE_FUNCTIONAPP_NAME }} --query "length(@)")
            if [ "$COUNT" -lt 1 ]; then
              echo "Error: No functions were discovered after deployment." >&2
              # Add a command to check the deployment logs for build failures
              echo "Checking deployment logs for build errors..."
              az functionapp log deployment show --resource-group ${{ env.RESOURCE_GROUP_NAME }} --name ${{ env.AZURE_FUNCTIONAPP_NAME }} --query "[0].log_time, [0].message" -o tsv || echo "Could not retrieve deployment logs."
              exit 1
            fi
            echo "Success: $COUNT function(s) discovered."
