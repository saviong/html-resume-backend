name: Deploy Python Function App to Azure

on:
  push:
    branches:
      - master

env:
  AZURE_FUNCTIONAPP_NAME: resumevisitor-fn # change this to your function app name
  AZURE_FUNCTIONAPP_PACKAGE_PATH: '.'   # set this to the path to your function app project, defaults to the repository root
  PYTHON_VERSION: '3.11'                # set this to the python version to use (e.g. '3.6', '3.7', '3.8')
  RESOURCE_GROUP_NAME: html-resume      # change this to your resource group name

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout GitHub Action'
        uses: actions/checkout@v4

      - name: 'Set up Python version'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 'Install dependencies'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Optional: Add a step to run tests here

      - name: 'Azure Login'
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Optional: If you are using ARM/Bicep templates to provision infrastructure
      - name: 'Deploy ARM Template'
        uses: azure/cli@v1
        with:
          inlineScript: |
            az deployment group create \
              --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
              --template-file ./template.json \
              --parameters @./parameters.json

      - name: 'Configure App Settings for Python v2 model and Remote Build'
        uses: azure/cli@v1
        with:
          inlineScript: |
            az functionapp config appsettings set \
              --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
              --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
              --settings SCM_DO_BUILD_DURING_DEPLOYMENT=true \
                         ENABLE_ORYX_BUILD=true \
                         AzureWebJobsFeatureFlags=EnableWorkerIndexing \
                         FUNCTIONS_WORKER_RUNTIME=python

      - name: 'Zip artifact for deployment'
        run: |
          zip -r function-app.zip . -x "*.git*" "*.github*" "local.settings.json" "*.venv/*" "__pycache__/*"

      - name: 'Deploy to Azure Functions'
        uses: Azure/functions-action@v1
        id: fa
        with:
          app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
          package: function-app.zip

      - name: 'Verify Function Discovery'
        uses: azure/cli@v1
        with:
          inlineScript: |
            sleep 60 # Give time for the function app to restart and discover functions
            echo "Listing functions in ${{ env.AZURE_FUNCTIONAPP_NAME }}..."
            az functionapp function list \
              --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
              --name ${{ env.AZURE_FUNCTIONAPP_NAME }} -o table
            COUNT=$(az functionapp function list -g ${{ env.RESOURCE_GROUP_NAME }} -n ${{ env.AZURE_FUNCTIONAPP_NAME }} --query "length(@)")
            if [ "$COUNT" -lt 1 ]; then
              echo "No functions discovered. Failing the job to surface the issue early." >&2
              exit 1
            fi
            echo "$COUNT function(s) discovered successfully."
